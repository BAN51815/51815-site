<div class="page-container">
  <style>
    .page-container {
      font-family: 'Helvetica Neue', sans-serif !important;
      padding: 1rem;
      background-color: #f9f9f9;
      max-width: 800px;
    }

    .page-container h2 {
      font-size: 1.4rem !important;
      margin-bottom: 1rem;
      color: #333;
    }

    .page-container label {
      display: block;
      margin-top: 1rem;
      font-weight: bold;
      font-size: 0.95rem;
    }

    .page-container input[type="text"],
    .page-container input[type="url"],
    .page-container input[type="file"],
    .page-container select {
      width: 100% !important;
      padding: 0.5rem !important;
      font-size: 0.9rem !important;
      margin-top: 0.3rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-sizing: border-box;
    }

    .page-container input[type="checkbox"] {
      transform: scale(1.2);
      margin-right: 0.5rem;
    }

    .page-container button {
      margin-top: 1.5rem;
      padding: 0.6rem 1.2rem;
      background-color: #4a90e2;
      color: white;
      font-size: 0.95rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    .page-container button:hover {
      background-color: #357ab8;
    }

    .page-container #thumbnail-preview {
      margin-top: 0.5rem;
      max-width: 100%;
      height: auto;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    #editor {
      border: 1px solid #ccc;
      margin-top: 0.5rem;
    }
  </style>

  <h2>ブログ投稿</h2>

  <label for="title">タイトル</label>
  <input type="text" id="title">

  <label for="category">カテゴリ</label>
  <select id="category"></select>
  <input type="text" id="category-new" placeholder="新しいカテゴリ名（任意）">

  <label for="tags">タグ（カンマ区切り）</label>
  <input type="text" id="tags">

  <label for="slug">スラッグ（URL用文字列）</label>
  <input type="text" id="slug">

  <label for="thumbnail_url">サムネイルURL</label>
  <input type="url" id="thumbnail_url">
  <label for="thumbnail_file">画像アップロード</label>
  <input type="file" id="thumbnail_file" accept="image/*">
  <img id="thumbnail-preview" src="" alt="プレビュー表示なし" style="display:none;">

  <label for="body">本文</label>
  <div id="editor"></div>

  <label><input type="checkbox" id="is_visible">公開する</label>

  <button id="submit-btn">投稿</button>

  <script src="https://cdn.ckeditor.com/ckeditor5/39.0.1/classic/ckeditor.js"></script>
  <script src="https://unpkg.com/wanakana"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    const supabase = createClient(
      "https://odpjnxcyvcmivmccxtyo.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kcGpueGN5dmNtaXZtY2N4dHlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjI0MjQsImV4cCI6MjA2NDE5ODQyNH0.uGSV1BPGvjcjGTtYOg0TwCarGTgdZeVWULSbdis_hsA"
    );

    if (localStorage.getItem("admin_auth") !== "true") {
      window.location.href = "admin-top.html";
    }

    let editorInstance;
    ClassicEditor.create(document.querySelector("#editor"))
      .then(editor => editorInstance = editor)
      .catch(err => console.error(err));

    const title = document.getElementById("title");
    const categorySelect = document.getElementById("category");
    const categoryNew = document.getElementById("category-new");
    const tags = document.getElementById("tags");
    const slugInput = document.getElementById("slug");
    const thumbnailUrl = document.getElementById("thumbnail_url");
    const thumbnailFile = document.getElementById("thumbnail_file");
    const preview = document.getElementById("thumbnail-preview");
    const isVisible = document.getElementById("is_visible");
    const submitBtn = document.getElementById("submit-btn");

    async function loadCategories() {
      const { data, error } = await supabase.from("categories").select("name");
      if (error || !data) return;
      const unique = [...new Set(data.map(row => row.name))];
      categorySelect.innerHTML = "";
      unique.forEach(name => {
        const opt = document.createElement("option");
        opt.value = name;
        opt.textContent = name;
        categorySelect.appendChild(opt);
      });
    }

    categoryNew.addEventListener("change", () => {
      if (categoryNew.value && ![...categorySelect.options].some(o => o.value === categoryNew.value)) {
        const opt = document.createElement("option");
        opt.value = categoryNew.value;
        opt.textContent = categoryNew.value;
        categorySelect.appendChild(opt);
        categorySelect.value = categoryNew.value;
      }
    });

    title.addEventListener("input", () => {
      const romaji = wanakana.toRomaji(title.value);
      const slug = romaji.toLowerCase().replace(/[^\w\s-]/g, "").trim().replace(/\s+/g, "-");
      slugInput.value = slug;
    });

    thumbnailUrl.addEventListener("input", () => {
      if (thumbnailUrl.value) {
        preview.src = thumbnailUrl.value;
        preview.style.display = "block";
      } else {
        preview.style.display = "none";
      }
    });

    submitBtn.addEventListener("click", async () => {
      const body = editorInstance.getData();
      const file = thumbnailFile.files[0];
      let finalThumb = thumbnailUrl.value;

      if (file) {
        const fileName = `thumbnails/${slugInput.value}-${Date.now()}-${file.name}`;
        const { error: uploadError } = await supabase.storage.from("thumbnails").upload(fileName, file);
        if (uploadError) {
          alert("画像アップロード失敗：" + uploadError.message);
          return;
        }
        const { data: urlData } = supabase.storage.from("thumbnails").getPublicUrl(fileName);
        finalThumb = urlData.publicUrl;
      }

      const { error } = await supabase.from("blogs").insert([{
        title: title.value,
        category: categorySelect.value,
        tags: tags.value,
        slug: slugInput.value,
        body: body,
        thumbnail_url: finalThumb,
        is_visible: isVisible.checked
      }]);

      if (error) alert("投稿失敗：" + error.message);
      else {
        alert("投稿完了！");
        title.value = tags.value = slugInput.value = thumbnailUrl.value = categoryNew.value = "";
        preview.style.display = "none";
        isVisible.checked = false;
        editorInstance.setData("");
        loadCategories();
      }
    });

    loadCategories();
  </script>
</div>
