<style>
.page-container * { box-sizing: border-box; }
  * { box-sizing: border-box; }
  .page-container .container { font-family: sans-serif; margin: 0; }
  h2 { margin: 0 0 1rem; }
  input, button { padding: 0.5rem; margin: 0.25rem; font-size: 1rem; }
  .page-container table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: #fff; }
  .page-container th, .page-container td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
  th { background: #eee; }
  .actions button { margin-right: 0.5rem; }
</style>

<h2>メニュー管理</h2>

<div>
  <input id="title" placeholder="タイトル">
  <input id="path" placeholder="パス（例: blog）">
  <input id="order" type="number" placeholder="順番">
  <button id="add-btn">追加</button>
</div>

<table>
  <thead>
    <tr><th>タイトル</th><th>パス</th><th>順番</th><th>公開</th><th>操作</th></tr>
  </thead>
  <tbody id="menu-list"></tbody>
</table>

<script type="module">
  if (localStorage.getItem("admin_auth") !== "true") {
    window.location.href = "admin-top.html";
  }

  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
  const supabase = createClient(
    "https://odpjnxcyvcmivmccxtyo.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kcGpueGN5dmNtaXZtY2N4dHlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjI0MjQsImV4cCI6MjA2NDE5ODQyNH0.uGSV1BPGvjcjGTtYOg0TwCarGTgdZeVWULSbdis_hsA"
  );

  const title = document.getElementById("title");
  const path = document.getElementById("path");
  const order = document.getElementById("order");
  const list = document.getElementById("menu-list");
  const addBtn = document.getElementById("add-btn");

  async function loadMenus() {
    const { data, error } = await supabase.from("menus").select("*").order("order");
    if (error) {
      alert("読み込み失敗: " + error.message);
      return;
    }

    list.innerHTML = "";
    data.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input value="${row.title}" data-id="${row.id}" data-field="title"></td>
        <td><input value="${row.path}" data-id="${row.id}" data-field="path"></td>
        <td><input type="number" value="${row.order}" data-id="${row.id}" data-field="order"></td>
        <td><input type="checkbox" data-id="${row.id}" data-field="is_visible" ${row.is_visible ? "checked" : ""}></td>
        <td class="actions">
          <button onclick="updateRow(${row.id})">保存</button>
          <button onclick="deleteRow(${row.id})">削除</button>
        </td>`;
      list.appendChild(tr);
    });
  }

  window.updateRow = async (id) => {
    const inputs = document.querySelectorAll('[data-id="' + id + '"]');
    const updateData = {};
    inputs.forEach(input => {
      if (input.type === "checkbox") {
        updateData[input.dataset.field] = input.checked;
      } else {
        updateData[input.dataset.field] = input.value;
      }
    });
    const { error } = await supabase.from("menus").update(updateData).eq("id", id);
    if (error) alert("更新失敗: " + error.message);
    else loadMenus();
  };

  window.deleteRow = async (id) => {
    if (!confirm("削除してもよいですか？")) return;
    const { error } = await supabase.from("menus").delete().eq("id", id);
    if (error) alert("削除失敗: " + error.message);
    else loadMenus();
  };

  addBtn.onclick = async () => {
    if (!title.value || !path.value || !order.value) return alert("全ての項目を入力してください");
    const { error } = await supabase.from("menus").insert([{ title: title.value, path: path.value, order: parseInt(order.value), is_visible: true }]);
    if (error) alert("追加失敗: " + error.message);
    else {
      title.value = path.value = order.value = "";
      loadMenus();
    }
  };

  loadMenus();
</script>
