<div class="page-container">
  <style>
    .page-container {
      font-family: 'Helvetica Neue', sans-serif !important;
      padding: 1rem;
      background-color: #f9f9f9;
    }

    .page-container h2 {
      font-size: 1.3rem !important;
      margin-bottom: 1rem;
      color: #333;
    }

    .page-container table {
      width: 100% !important;
      border-collapse: collapse !important;
      margin-top: 1rem;
      background: #fff;
      font-size: 0.85rem !important;
      table-layout: fixed !important;
      word-break: break-word !important;
    }

    .page-container th,
    .page-container td {
      border: 1px solid #ccc !important;
      padding: 0.4rem 0.5rem !important;
      text-align: left;
    }

    .page-container th {
      background: #eee !important;
    }

    .page-container input[type="text"],
    .page-container input[type="number"] {
      width: 100% !important;
      padding: 0.3rem !important;
      font-size: 0.85rem !important;
      box-sizing: border-box !important;
    }

    .page-container input[type="checkbox"] {
      transform: scale(1.2);
    }

    .page-container button {
      background-color: #4a90e2 !important;
      color: white !important;
      border: none;
      border-radius: 6px;
      padding: 0.3rem 0.6rem !important;
      margin-right: 0.3rem !important;
      font-size: 0.8rem !important;
      cursor: pointer !important;
    }

    .page-container button:hover {
      background-color: #357ab8 !important;
    }
  </style>

  <h2>ブログ記事一覧</h2>

  <table>
    <thead>
      <tr>
        <th>タイトル</th>
        <th>カテゴリ</th>
        <th>タグ</th>
        <th>スラッグ</th>
        <th>サムネイルURL</th>
        <th>公開</th>
        <th>作成日</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="blog-list"></tbody>
  </table>

  <script type="module">
    if (localStorage.getItem("admin_auth") !== "true") {
      window.location.href = "admin-top.html";
    }

    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabase = createClient(
      "https://odpjnxcyvcmivmccxtyo.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kcGpueGN5dmNtaXZtY2N4dHlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg2MjI0MjQsImV4cCI6MjA2NDE5ODQyNH0.uGSV1BPGvjcjGTtYOg0TwCarGTgdZeVWULSbdis_hsA"
    );

    const tbody = document.getElementById("blog-list");

    async function loadBlogs() {
      const { data, error } = await supabase
        .from("blogs")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) {
        tbody.innerHTML = "<tr><td colspan='8'>読み込み失敗</td></tr>";
        console.error(error);
        return;
      }

      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="text" value="${row.title}" data-id="${row.id}" data-field="title"></td>
          <td><input type="text" value="${row.category}" data-id="${row.id}" data-field="category"></td>
          <td><input type="text" value="${row.tags || ""}" data-id="${row.id}" data-field="tags"></td>
          <td><input type="text" value="${row.slug || ""}" data-id="${row.id}" data-field="slug"></td>
          <td><input type="text" value="${row.thumbnail_url || ""}" data-id="${row.id}" data-field="thumbnail_url"></td>
          <td><input type="checkbox" data-id="${row.id}" data-field="is_visible" ${row.is_visible ? "checked" : ""}></td>
          <td>${new Date(row.created_at).toLocaleString()}</td>
          <td>
            <button onclick="updateRow(${row.id})">保存</button>
            <button onclick="deleteRow(${row.id})">削除</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    window.updateRow = async (id) => {
      const inputs = document.querySelectorAll('[data-id="' + id + '"]');
      const updateData = {};
      inputs.forEach(input => {
        const field = input.dataset.field;
        if (input.type === "checkbox") {
          updateData[field] = input.checked;
        } else {
          updateData[field] = input.value;
        }
      });
      const { error } = await supabase.from("blogs").update(updateData).eq("id", id);
      if (error) alert("更新失敗: " + error.message);
      else loadBlogs();
    };

    window.deleteRow = async (id) => {
      if (!confirm("この投稿を削除しますか？")) return;
      const { error } = await supabase.from("blogs").delete().eq("id", id);
      if (error) alert("削除失敗: " + error.message);
      else loadBlogs();
    };

    loadBlogs();
  </script>
</div>
