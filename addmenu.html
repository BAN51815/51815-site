
<main class="p-4">
<h1 class="text-xl font-bold mb-4">管理メニュー追加・編集・削除（デバッグモード）</h1>
<div class="mb-4 flex gap-2">
<input class="border p-1 rounded w-72" id="title-input" placeholder="タイトル"/>
<input class="border p-1 rounded w-72" id="path-input" placeholder="パス"/>
<button class="bg-blue-500 text-white px-3 py-1 rounded" id="add-button">追加</button>
</div>
<table class="w-full border text-sm">
<thead class="bg-gray-100">
<tr>
<th class="border px-2 py-1">タイトル</th>
<th class="border px-2 py-1">パス</th>
<th class="border px-2 py-1">操作</th>
</tr>
</thead>
<tbody id="menu-table"></tbody>
</table>
</main>
<script type="module">
console.log("✅ JSモジュール開始");

try {
  const supabase = createClient("https://odpjnxcyvcmivmccxtyo.supabase.co", "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kcGpueGN5dmNtaXZtY2N4dHlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU5ODk1NzgsImV4cCI6MjA2MTU2NTU3OH0.dqy_L8iPlbUDoozkha4yjar4ADvinxGc0a6ygSuBLQI");
  console.log("✅ Supabase 初期化完了");

  const user = await supabase.auth.getUser();
  console.log("✅ ユーザー取得:", user);

  const { data, error } = await supabase.from("admin_menus").select("*");
  console.log("✅ データ取得結果:", data);
  if (error) console.error("❌ Supabaseエラー:", error);
  if (!data || data.length === 0) console.warn("⚠ データが空です");

} catch (err) {
  console.error("❌ 例外エラー:", err);
}


console.log("✅ JS開始：モジュールスクリプト動作中");

import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient(
  "https://odpjnxcyvcmivmccxtyo.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kcGpueGN5dmNtaXZtY2N4dHlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTcwNTYxNDksImV4cCI6MjAzMjYzMjE0OX0.mEA8aT-Pa3UHgMQh19K5X82idAy28vv0ndWeClqRDLU"
);

const { data: authUser, error: authError } = await supabase.auth.getUser();
console.log("🔑 認証チェック結果：", authUser);
if (!authUser?.user) {
  console.warn("🚫 未ログイン。リダイレクトします");
  location.href = "admin-top.html";
}

loadMenu();

async function loadMenu() {
  console.log("📥 メニュー読み込み開始...");
  const { data, error } = await supabase.from("admin_menus").select("*").order("order", { ascending: true });
  if (error) {
    console.error("❌ データ取得エラー:", error);
    return;
  }
  console.log("✅ メニュー取得成功:", data);
  console.log("取得結果 data:", data);
  console.log("取得結果 error:", error);

  const table = document.getElementById("menu-table");
  table.innerHTML = "";
  data.forEach((item) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="border px-2 py-1"><input value="${item.title}" class="border rounded w-full px-1 py-0.5" data-id="${item.id}" data-field="title"></td>
      <td class="border px-2 py-1"><input value="${item.path}" class="border rounded w-full px-1 py-0.5" data-id="${item.id}" data-field="path"></td>
      <td class="border px-2 py-1 text-center">
        <button class="bg-green-500 text-white px-2 py-0.5 rounded save-button" data-id="${item.id}">保存</button>
        <button class="bg-red-500 text-white px-2 py-0.5 rounded delete-button" data-id="${item.id}">削除</button>
      </td>
    `;
    table.appendChild(row);
  });

  document.querySelectorAll(".save-button").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      const title = document.querySelector(`input[data-id='${id}'][data-field='title']`).value;
      const path = document.querySelector(`input[data-id='${id}'][data-field='path']`).value;
      await supabase.from("admin_menus").update({ title, path }).eq("id", id);
      loadMenu();
    });
  });

  document.querySelectorAll(".delete-button").forEach((btn) => {
    btn.addEventListener("click", async () => {
      const id = btn.dataset.id;
      if (confirm("削除してよろしいですか？")) {
        await supabase.from("admin_menus").delete().eq("id", id);
        loadMenu();
      }
    });
  });
}

document.getElementById("add-button").addEventListener("click", async () => {
  const title = document.getElementById("title-input").value;
  const path = document.getElementById("path-input").value;
  if (!title || !path) return alert("タイトルとパスは必須です");
  await supabase.from("admin_menus").insert({ title, path });
  document.getElementById("title-input").value = "";
  document.getElementById("path-input").value = "";
  loadMenu();
});
</script>
